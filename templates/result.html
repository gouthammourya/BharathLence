<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BharatLens – Result</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
</head>
<body class="bg-dark text-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">Scan Result</h1>

    <div class="row">
      <!-- Left column -->
      <div class="col-md-6 mb-4">
        <div class="card card-glass p-3 mb-3">
          <h5>Raw Text / Notes</h5>
          <p class="small mb-0">
            {{ raw_text or ('Manual search for route ' ~ route_no if route_no else 'No OCR text.') }}
          </p>
        </div>

        <div class="card card-glass p-3">
          <h5>Route Details (Dataset / Live)</h5>
          {% if route_info and not route_info.get('error') %}
            <ul class="mb-0">
              <li><strong>Route No:</strong> {{ route_info.route_no }}</li>
              <li><strong>Operator:</strong> {{ route_info.operator }}</li>
              <li><strong>City/Region:</strong> {{ route_info.city }}</li>
              <li><strong>From:</strong> {{ route_info["from"] }}</li>
              <li><strong>To:</strong> {{ route_info["to"] }}</li>
              <li><strong>First Bus:</strong> {{ route_info.first_bus }}</li>
              <li><strong>Last Bus:</strong> {{ route_info.last_bus }}</li>
              <li><strong>Frequency:</strong> Every {{ route_info.frequency_minutes }} minutes</li>
              {% if route_info.eta_minutes is defined %}
                <li><strong>Next Bus ETA (BMTC Live):</strong> ~{{ route_info.eta_minutes }} minutes</li>
              {% endif %}
            </ul>
          {% else %}
            <p class="small mb-0">
              {{ route_info.error if route_info else 'Route not found in dataset.' }}
            </p>
          {% endif %}
        </div>
      </div>

      <!-- Right column -->
      <div class="col-md-6 mb-4">
        <div class="card card-glass p-3 mb-3">
          <h5>
            AI Explanation
            {% if target_lang == 'hi' %}
              (Hindi)
            {% elif target_lang == 'kn' %}
              (Kannada)
            {% else %}
              (English)
            {% endif %}
          </h5>
          <p class="mb-0">{{ final_text }}</p>
        </div>

        <div class="card card-glass p-3 text-center">
          <h5>Listen</h5>

          <!-- If audio already exists, show audio player and download -->
          {% if audio_file %}
            <audio controls class="w-100 mt-2">
              <source src="{{ audio_file }}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
            <a class="btn btn-sm btn-outline-light mt-2" href="{{ audio_file }}" download>
              Download audio
            </a>
          {% else %}
            <p class="small mb-2">Audio not yet generated.</p>

            <!-- Form to request generation of TTS on the server.
                 Posts to /route-search (same server flow), with tts=1 so server will generate audio file. -->
            <form id="tts-form" method="POST" action="{{ url_for('route_search') }}">
              <!-- include route_no so server can generate text from dataset -->
              <input type="hidden" name="route_no" value="{{ route_no }}">
              <!-- pass target_lang so TTS uses the selected language -->
              <input type="hidden" name="target_lang" value="{{ target_lang }}">
              <!-- flag to tell server to create TTS -->
              <input type="hidden" name="tts" value="1">
              <button id="tts-btn" type="submit" class="btn btn-primary">
                Generate Audio (Listen)
              </button>
              <div id="tts-spinner" class="spinner-border spinner-border-sm text-light ms-2" role="status" style="display:none;">
                <span class="visually-hidden">Generating...</span>
              </div>
            </form>

            <p class="small text-muted mt-2">Tip: If generation fails, ensure gTTS/pyttsx3 are installed and server has network (for gTTS).</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="text-center mt-3">
      <a href="{{ url_for('index') }}" class="btn btn-outline-light me-2">
        Scan Another / Search Again
      </a>
      <a href="{{ url_for('history') }}" class="btn btn-outline-secondary">
        View History
      </a>
    </div>
  </div>

  <script>
    // Small UX: disable button and show spinner while TTS generation request is running.
    (function(){
      const form = document.getElementById('tts-form');
      const btn = document.getElementById('tts-btn');
      const spinner = document.getElementById('tts-spinner');
      if (!form || !btn) return;
      form.addEventListener('submit', function () {
        btn.disabled = true;
        btn.innerText = 'Generating…';
        if (spinner) spinner.style.display = 'inline-block';
      });
    })();
  </script>
</body>
</html>
